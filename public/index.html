<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 掃除当番表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .day {
            min-height: 120px;
        }
        .day-name {
            font-size: 0.75rem;
        }
        .saturday { color: #3b82f6; }
        .sunday { color: #ef4444; }
        .holiday-name {
            font-size: 0.7rem;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            background-color: #ef4444;
            display: inline-block;
            margin-top: 4px;
        }
        .modal {
            display: none;
        }
        .modal.flex {
            display: flex;
        }
        /* トースト通知 */
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        #toast.show {
            bottom: 30px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- 全体を囲むコンテナ -->
    <div id="app-container" class="p-4 md:p-8 max-w-7xl mx-auto opacity-0 transition-opacity duration-500">
        <!-- ヘッダー -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">掃除当番表</h1>
            <button id="settings-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105">
                <i class="fas fa-cog mr-2"></i>設定
            </button>
        </header>

        <!-- カレンダーコントロール -->
        <div class="flex items-center justify-center space-x-4 mb-4 bg-white p-3 rounded-lg shadow">
            <button id="prev-month" class="px-4 py-2 rounded-lg hover:bg-gray-200 transition"><i class="fas fa-chevron-left"></i></button>
            <h2 id="month-year" class="text-xl md:text-2xl font-semibold w-48 text-center"></h2>
            <button id="next-month" class="px-4 py-2 rounded-lg hover:bg-gray-200 transition"><i class="fas fa-chevron-right"></i></button>
            <button id="today-button" class="hidden md:block bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition">今日</button>
        </div>
        
        <!-- カレンダー -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="calendar-grid border-b border-gray-200">
                <div class="p-2 text-center font-bold day-name sunday">日</div>
                <div class="p-2 text-center font-bold day-name">月</div>
                <div class="p-2 text-center font-bold day-name">火</div>
                <div class="p-2 text-center font-bold day-name">水</div>
                <div class="p-2 text-center font-bold day-name">木</div>
                <div class="p-2 text-center font-bold day-name">金</div>
                <div class="p-2 text-center font-bold day-name saturday">土</div>
            </div>
            <div id="calendar" class="calendar-grid">
                <!-- 日付セルはここに動的に生成されます -->
            </div>
        </div>
        <div class="text-xs text-gray-500 mt-2 text-right">ユーザーID: <span id="user-id-display"></span></div>

    </div>

    <!-- ログインモーダル (初期状態は非表示) -->
    <div id="login-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-6">ログイン</h2>
            <p class="text-sm text-gray-600 mb-4">設定されたパスワードを入力してください。</p>
            <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="パスワード">
            <button id="login-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105">
                <i class="fas fa-sign-in-alt mr-2"></i>ログイン
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 h-5"></p>
        </div>
    </div>

    <!-- 設定モーダル (初期状態は非表示) -->
    <div id="settings-modal" class="modal fixed inset-0 bg-gray-800 bg-opacity-60 items-center justify-center z-40">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-bold text-gray-800">各種設定</h2>
                <button id="close-settings-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <!-- 担当者管理 -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">担当者管理</h3>
                <div id="staff-list" class="space-y-3 mb-4"></div>
                <div class="flex space-x-2">
                    <input type="text" id="new-staff-name" placeholder="新しい担当者名" class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button id="add-staff-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow transition">
                        <i class="fas fa-plus"></i> 追加
                    </button>
                </div>
                <button id="reset-staff-button" class="mt-4 text-sm text-red-600 hover:underline">担当者リストを初期状態にリセット</button>
            </div>

            <!-- 休日設定 -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">休日設定 (YYYY-MM-DD)</h3>
                <div class="flex space-x-2">
                    <input type="date" id="new-holiday" class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button id="add-holiday-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow transition">追加</button>
                </div>
                <div id="holiday-list" class="mt-3 flex flex-wrap gap-2"></div>
            </div>

            <!-- 出勤日設定 -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">出勤日設定（祝日にも関わらず出勤する日）</h3>
                <p class="text-sm text-gray-500 mb-3">ここで指定した日付は、祝日であっても当番が割り当てられます。</p>
                <div class="flex space-x-2">
                    <input type="date" id="new-workday-override" class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button id="add-workday-override-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow transition">追加</button>
                </div>
                <div id="workday-override-list" class="mt-3 flex flex-wrap gap-2"></div>
            </div>
            
            <!-- 休日一覧表示 -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">現在設定されている休日一覧（土日除く）</h3>
                <p class="text-sm text-gray-500 mb-3">日本の祝日リストです。手動で追加・削除した休日は反映されません。</p>
                <div id="final-holiday-list" class="mt-3 p-3 bg-gray-50 rounded-md max-h-48 overflow-y-auto">
                    <!-- List will be generated here -->
                </div>
            </div>

            <!-- その他設定 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">当番割り当て開始日</h3>
                    <input type="date" id="start-date-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">パスワード変更</h3>
                    <input type="password" id="new-password-input" placeholder="新しいパスワード" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            </div>

            <div class="mt-8 pt-6 border-t flex justify-end">
                <button id="save-settings-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow transition">
                    <i class="fas fa-save mr-2"></i>保存
                </button>
            </div>
        </div>
    </div>
    
    <!-- 担当変更モーダル (初期状態は非表示) -->
    <div id="edit-modal" class="modal fixed inset-0 bg-gray-800 bg-opacity-60 items-center justify-center z-40">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-xl font-bold mb-2">担当者変更</h2>
            <p class="text-gray-600 mb-6" id="edit-modal-date"></p>
            
            <div class="mb-4">
                <label for="staff-select" class="block text-sm font-medium text-gray-700 mb-1">担当者</label>
                <select id="staff-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
            </div>

            <div class="flex justify-between items-center mt-8">
                <button id="reset-assignment-button" class="text-sm text-blue-600 hover:underline">自動割当に戻す</button>
                <div class="space-x-3">
                    <button id="close-edit-modal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">キャンセル</button>
                    <button id="save-edit-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- トースト通知 -->
    <div id="toast"></div>

    <!-- 確認モーダル (初期状態は非表示) -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">確認</h2>
            <p id="confirm-modal-text" class="text-gray-600 mb-8"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">キャンセル</button>
                <button id="confirm-modal-ok" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            collection,
            addDoc,
            deleteDoc,
            query,
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- グローバル変数と定数 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cleaning-roster';

        const firebaseConfigFromConsole = {
            apiKey: "AIzaSyBBAqtjYFYorFBbA6WRzWFXyBpI9jEdgms",
            authDomain: "its-workplace-beautification.firebaseapp.com",
            projectId: "its-workplace-beautification",
            storageBucket: "its-workplace-beautification.firebasestorage.app",
            messagingSenderId: "698218638954",
            appId: "1:698218638954:web:8940530c9aeb8a7841a413",
        };

        let firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config && Object.keys(__firebase_config).length > 0)
            ? (typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config)
            : firebaseConfigFromConsole;

        try {
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase configuration object is invalid or placeholder.", firebaseConfig);
                firebaseConfig = null;
            }
        } catch (e) {
            console.error("Failed to process Firebase config:", e);
            firebaseConfig = null;
        }
        
        let app, auth, db;
        let currentUserId = null;
        
        let currentDate = new Date();
        let staffList = [];
        let settings = {};
        let manualOverrides = {};
        let holidaysJP = {}; // 祝日データ
        let listenersAttached = false; // リスナーの多重設定を防ぐフラグ

        const initialStaffNames = [
            '伊勢', '藤生', '森田', '今関', '吉岡', '飛知和', '山口', '小田', '小林', '新井',
            '中野', '清水', '内田', '岡崎', '長谷川', '佐下橋', '林部', '境田', '山内',
            '寺尾', '白倉', '佐藤', '村上', '熊田', '武澤', '荒井', '後藤', '伊藤', '菱山'
        ];

        // --- DOM要素 ---
        const loginModal = document.getElementById('login-modal');
        const appContainer = document.getElementById('app-container');
        const loginButton = document.getElementById('login-button');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- 初期化処理 ---
        async function addInitialStaff(staffCollectionRef) {
            console.log("担当者データを初期化します。");
            const batch = writeBatch(db);
            initialStaffNames.forEach((name, index) => {
                const newStaffRef = doc(staffCollectionRef);
                batch.set(newStaffRef, {
                    name: name,
                    availableDays: [1, 2, 3, 4, 5], // デフォルトは月〜金
                    order: index // 順番を保存
                });
            });

            try {
                await batch.commit();
                showToast('初期担当者リストをデータベースに作成しました', 'success');
            } catch (error) {
                console.error("初期担当者の追加に失敗しました:", error);
                showToast('初期担当者の追加に失敗しました', 'error');
            }
        }

        async function initializeAppAndAuth() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing or invalid. App cannot start.");
                loginModal.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm text-center"><h2 class="text-2xl font-bold mb-4 text-red-600">設定エラー</h2><p>Firebaseの接続設定が不完全です。アプリを初期化できません。</p></div>`;
                loginModal.classList.add('flex');
                return;
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // 【最重要】最初に認証を行う
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = currentUserId;
                    
                    if (!listenersAttached) { // このチェックを追加
                        // 最初に担当者リストが空か一度だけチェックし、空なら初期データを投入
                        const staffCollectionRef = collection(db, `artifacts/${appId}/public/data/staff`);
                        const initialCheckSnapshot = await getDocs(query(staffCollectionRef));
                        if (initialCheckSnapshot.empty) {
                            await addInitialStaff(staffCollectionRef);
                        }
                        
                        // 認証後、データ監視を開始
                        setupFirestoreListeners();
                    }
                    
                    loginModal.classList.add('flex');
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Anonymous sign-in failed", error);
                        loginError.textContent = "認証に失敗しました。";
                    }
                }
            });
            setHolidays();
        }

        // 祝日データを直接定義
        function setHolidays() {
            // 2024-2026年の日本の祝日データ
            const holidaysData = {
                '2024-01-01': '元日', '2024-01-08': '成人の日', '2024-02-11': '建国記念の日', '2024-02-12': '振替休日', '2024-02-23': '天皇誕生日', '2024-03-20': '春分の日', '2024-04-29': '昭和の日', '2024-05-03': '憲法記念日', '2024-05-04': 'みどりの日', '2024-05-05': 'こどもの日', '2024-05-06': '振替休日', '2024-07-15': '海の日', '2024-08-11': '山の日', '2024-08-12': '振替休日', '2024-09-16': '敬老の日', '2024-09-22': '秋分の日', '2024-09-23': '振替休日', '2024-10-14': 'スポーツの日', '2024-11-03': '文化の日', '2024-11-04': '振替休日', '2024-11-23': '勤労感謝の日',
                '2025-01-01': '元日', '2025-01-13': '成人の日', '2025-02-11': '建国記念の日', '2025-02-23': '天皇誕生日', '2025-02-24': '振替休日', '2025-03-20': '春分の日', '2025-04-29': '昭和の日', '2025-05-03': '憲法記念日', '2025-05-04': 'みどりの日', '2025-05-05': 'こどもの日', '2025-05-06': '振替休日', '2025-07-21': '海の日', '2025-08-11': '山の日', '2025-09-15': '敬老の日', '2025-09-23': '秋分の日', '2025-10-13': 'スポーツの日', '2025-11-03': '文化の日', '2025-11-23': '勤労感謝の日', '2025-11-24': '振替休日',
                '2026-01-01': '元日', '2026-01-12': '成人の日', '2026-02-11': '建国記念の日', '2026-02-23': '天皇誕生日', '2026-03-20': '春分の日', '2026-04-29': '昭和の日', '2026-05-03': '憲法記念日', '2026-05-04': 'みどりの日', '2026-05-05': 'こどもの日', '2026-05-06': '振替休日', '2026-07-20': '海の日', '2026-08-11': '山の日', '2026-09-21': '敬老の日', '2026-09-23': '秋分の日', '2026-10-12': 'スポーツの日', '2026-11-03': '文化の日', '2026-11-23': '勤労感謝の日'
            };
            holidaysJP = holidaysData;
        }
        
        // --- Firestoreリスナー ---
        function setupFirestoreListeners() {
            if (listenersAttached) return; // 多重設定を防止
            listenersAttached = true;

            const settingsRef = doc(db, `artifacts/${appId}/public/data/settings`, "config");
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    settings = docSnap.data();
                } else {
                    // デフォルト設定
                    settings = {
                        password: 'password',
                        startDate: new Date().toISOString().split('T')[0],
                        holidays: [],
                        workdayOverrides: [],
                    };
                }
            });

            const staffRef = collection(db, `artifacts/${appId}/public/data/staff`);
            onSnapshot(query(staffRef), async (querySnapshot) => {
                staffList = [];
                let needsOrderUpdate = false;
                const staffNameOrderMap = Object.fromEntries(initialStaffNames.map((name, index) => [name, index]));
                const batch = writeBatch(db);

                querySnapshot.forEach((doc) => {
                    const staffData = { id: doc.id, ...doc.data() };
                    if (staffData.order === undefined && staffNameOrderMap[staffData.name] !== undefined) {
                        needsOrderUpdate = true;
                        const docRef = doc(db, `artifacts/${appId}/public/data/staff`, doc.id);
                        batch.update(docRef, { order: staffNameOrderMap[staffData.name] });
                        staffData.order = staffNameOrderMap[staffData.name];
                    }
                    staffList.push(staffData);
                });

                if (needsOrderUpdate) {
                    console.log("担当者の順番データを更新します。");
                    try {
                        await batch.commit();
                        showToast('担当者の順番を更新しました。', 'success');
                    } catch (e) {
                        console.error("担当者の順番更新に失敗しました:", e);
                    }
                }

                staffList.sort((a, b) => (a.order !== undefined ? a.order : 999) - (b.order !== undefined ? b.order : 999));
                
                renderCalendar();
                renderSettings();
            });
            
            const overridesRef = collection(db, `artifacts/${appId}/public/data/manualOverrides`);
            onSnapshot(query(overridesRef), (querySnapshot) => {
                manualOverrides = {};
                querySnapshot.forEach((doc) => {
                    manualOverrides[doc.id] = doc.data();
                });
                renderCalendar();
            });
        }
        
        // --- カレンダー描画 ---
        function renderCalendar() {
            if (!isLoggedIn()) return; // ログイン前は描画しない
            
            const calendarEl = document.getElementById('calendar');
            const monthYearEl = document.getElementById('month-year');
            calendarEl.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.textContent = `${year}年 ${month + 1}月`;
            
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startingDay = firstDayOfMonth.getDay();

            const assignments = calculateAssignments();

            for (let i = 0; i < startingDay; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'p-2 border-r border-b border-gray-200 bg-gray-50';
                calendarEl.appendChild(dayEl);
            }

            for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateString = toYYYYMMDD(date);
                const dayOfWeek = date.getDay();
                
                const dayEl = document.createElement('div');
                dayEl.className = 'day p-2 border-r border-b border-gray-200 flex flex-col relative';
                
                let dateClasses = 'font-bold text-sm';
                if (dayOfWeek === 0) dateClasses += ' sunday';
                if (dayOfWeek === 6) dateClasses += ' saturday';

                const dateNumEl = document.createElement('span');
                dateNumEl.className = dateClasses;
                dateNumEl.textContent = day;
                dayEl.appendChild(dateNumEl);

                if (holidaysJP[dateString] && !(settings.workdayOverrides || []).includes(dateString)) {
                     dayEl.classList.add('bg-red-50');
                     dateNumEl.classList.add('sunday');
                     const holidayEl = document.createElement('span');
                     holidayEl.className = 'holiday-name';
                     holidayEl.textContent = holidaysJP[dateString];
                     dayEl.appendChild(holidayEl);
                }

                const staffName = manualOverrides[dateString]?.staffName || assignments[dateString];
                if (staffName) {
                    const assignmentEl = document.createElement('div');
                    assignmentEl.className = `mt-2 p-2 rounded-md text-center text-sm font-semibold ${staffName === '休み' ? 'bg-gray-200 text-gray-600' : 'bg-blue-100 text-blue-800'}`;
                    assignmentEl.textContent = staffName;
                    dayEl.appendChild(assignmentEl);
                }

                if (manualOverrides[dateString]) {
                    const indicator = document.createElement('i');
                    indicator.className = 'fas fa-pen-square absolute top-2 right-2 text-yellow-500 text-xs';
                    dayEl.appendChild(indicator);
                }

                dayEl.addEventListener('click', () => openEditModal(dateString));
                calendarEl.appendChild(dayEl);
            }
        }

        // --- 当番割り当てロジック (公平な順番) ---
        function calculateAssignments() {
            if (!staffList.length || !settings.startDate) return {};
            if (staffList.length === 0) return {};

            const assignments = {};
            const assignmentQueue = [...staffList]; // 担当の順番を管理するキュー

            const allPotentialHolidays = new Set([...(settings.holidays || []), ...Object.keys(holidaysJP)]);
            const workdayOverrides = new Set(settings.workdayOverrides || []);
            workdayOverrides.forEach(d => allPotentialHolidays.delete(d));

            let currentDateIter = new Date(settings.startDate);
            const endDate = new Date();
            endDate.setFullYear(endDate.getFullYear() + 1);

            while (currentDateIter <= endDate) {
                const dateString = toYYYYMMDD(currentDateIter);
                const dayOfWeek = currentDateIter.getDay();

                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !allPotentialHolidays.has(dateString)) {
                    let assigned = false;
                    
                    // キューの中から、その曜日に担当できる人を順番に探す
                    for (let i = 0; i < assignmentQueue.length; i++) {
                        const staffMember = assignmentQueue[i];
                        if (staffMember.availableDays.includes(dayOfWeek)) {
                            // 担当者が見つかった
                            assignments[dateString] = staffMember.name;
                            
                            // 担当した人をキューから削除し、末尾に移動
                            const [assignedStaff] = assignmentQueue.splice(i, 1);
                            assignmentQueue.push(assignedStaff);
                            
                            assigned = true;
                            break; // この日の割り当ては完了
                        }
                    }

                    if (!assigned) {
                        assignments[dateString] = "該当者なし";
                    }
                }
                currentDateIter.setDate(currentDateIter.getDate() + 1);
            }
            return assignments;
        }

        // --- 設定モーダル関連 ---
        function renderSettings() {
            const staffListEl = document.getElementById('staff-list');
            staffListEl.innerHTML = '';
            staffList.forEach(staff => {
                const staffDiv = document.createElement('div');
                staffDiv.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-md';
                staffDiv.innerHTML = `
                    <span class="font-medium">${staff.name}</span>
                    <div class="flex items-center space-x-2">
                        ${[ '月', '火', '水', '木', '金'].map((day, i) => `
                            <label class="flex items-center space-x-1 text-sm">
                                <input type="checkbox" data-staff-id="${staff.id}" data-day="${i+1}" ${staff.availableDays.includes(i+1) ? 'checked' : ''} class="rounded text-blue-500 focus:ring-blue-400">
                                <span>${day}</span>
                            </label>
                        `).join('')}
                        <button data-staff-id="${staff.id}" class="remove-staff-button text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                staffListEl.appendChild(staffDiv);
            });
            
            const holidayListEl = document.getElementById('holiday-list');
            holidayListEl.innerHTML = '';
            (settings.holidays || []).forEach(holiday => {
                const holidayTag = document.createElement('div');
                holidayTag.className = 'flex items-center bg-red-100 text-red-800 text-sm font-medium px-2.5 py-1 rounded-full';
                holidayTag.innerHTML = `
                    <span>${holiday}</span>
                    <button data-holiday="${holiday}" class="remove-holiday-button ml-2 text-red-500 hover:text-red-700">&times;</button>
                `;
                holidayListEl.appendChild(holidayTag);
            });
            
            const workdayOverrideListEl = document.getElementById('workday-override-list');
            workdayOverrideListEl.innerHTML = '';
            (settings.workdayOverrides || []).forEach(workday => {
                const workdayTag = document.createElement('div');
                workdayTag.className = 'flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-1 rounded-full';
                workdayTag.innerHTML = `
                    <span>${workday}</span>
                    <button data-workday="${workday}" class="remove-workday-override-button ml-2 text-blue-500 hover:text-blue-700">&times;</button>
                `;
                workdayOverrideListEl.appendChild(workdayTag);
            });
            
            const finalHolidayListEl = document.getElementById('final-holiday-list');
            finalHolidayListEl.innerHTML = '';

            const allPotentialHolidays = new Set([...(settings.holidays || []), ...Object.keys(holidaysJP)]);
            const workdayOverrides = new Set(settings.workdayOverrides || []);
            workdayOverrides.forEach(d => allPotentialHolidays.delete(d));

            const finalHolidays = Array.from(allPotentialHolidays)
                .filter(dateString => {
                    const date = new Date(dateString);
                    const dayOfWeek = date.getDay();
                    return dayOfWeek !== 0 && dayOfWeek !== 6;
                })
                .sort();

            if (finalHolidays.length > 0) {
                const holidaysByMonth = finalHolidays.reduce((acc, dateString) => {
                    const month = dateString.substring(0, 7);
                    if (!acc[month]) acc[month] = [];
                    acc[month].push(dateString);
                    return acc;
                }, {});

                Object.keys(holidaysByMonth).sort().forEach(month => {
                    const monthHeader = document.createElement('h4');
                    const [year, m] = month.split('-');
                    monthHeader.textContent = `${year}年${parseInt(m, 10)}月`;
                    monthHeader.className = 'font-semibold text-gray-600 mt-2';
                    finalHolidayListEl.appendChild(monthHeader);

                    const dateList = document.createElement('div');
                    dateList.className = 'flex flex-wrap gap-2 mt-1';
                    
                    holidaysByMonth[month].forEach(dateString => {
                        const dateTag = document.createElement('div');
                        dateTag.className = 'bg-red-100 text-red-800 text-sm font-medium px-2.5 py-1 rounded-full';
                        const date = new Date(dateString);
                        const day = date.getDate();
                        const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                        const holidayName = holidaysJP[dateString] || '指定休日';
                        dateTag.textContent = `${day}日(${dayOfWeek}) - ${holidayName}`;
                        dateList.appendChild(dateTag);
                    });
                    finalHolidayListEl.appendChild(dateList);
                });

            } else {
                finalHolidayListEl.textContent = '現在設定されている休日はありません。';
            }
            document.getElementById('start-date-input').value = settings.startDate || '';
        }
        
        async function saveSettings() {
            try {
                const batch = writeBatch(db);
                
                const staffCheckboxes = document.querySelectorAll('#staff-list input[type="checkbox"]');
                const staffUpdates = {};
                staffCheckboxes.forEach(cb => {
                    const staffId = cb.dataset.staffId;
                    const day = parseInt(cb.dataset.day);
                    if (!staffUpdates[staffId]) staffUpdates[staffId] = [];
                    if (cb.checked) {
                        staffUpdates[staffId].push(day);
                    }
                });

                Object.keys(staffUpdates).forEach(staffId => {
                    const staffRef = doc(db, `artifacts/${appId}/public/data/staff`, staffId);
                    batch.update(staffRef, { availableDays: staffUpdates[staffId] });
                });

                const newPassword = document.getElementById('new-password-input').value;
                const newSettings = {
                    startDate: document.getElementById('start-date-input').value,
                    holidays: Array.from(document.querySelectorAll('.remove-holiday-button')).map(btn => btn.dataset.holiday),
                    workdayOverrides: Array.from(document.querySelectorAll('.remove-workday-override-button')).map(btn => btn.dataset.workday)
                };
                if (newPassword) {
                    newSettings.password = newPassword;
                }

                const settingsRef = doc(db, `artifacts/${appId}/public/data/settings`, "config");
                batch.set(settingsRef, newSettings, { merge: true });

                await batch.commit();
                
                document.getElementById('new-password-input').value = '';
                showToast('設定を保存しました', 'success');
                settingsModal.classList.remove('flex');

            } catch (error) {
                console.error("Error saving settings:", error);
                showToast('設定の保存に失敗しました', 'error');
            }
        }

        let editingDate = null;
        function openEditModal(dateString) {
            editingDate = dateString;
            document.getElementById('edit-modal-date').textContent = dateString;
            const selectEl = document.getElementById('staff-select');
            selectEl.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = 'auto';
            defaultOption.textContent = '自動割り当て';
            selectEl.appendChild(defaultOption);

            const restOption = document.createElement('option');
            restOption.value = '休み';
            restOption.textContent = '休み';
            selectEl.appendChild(restOption);

            staffList.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.id;
                option.textContent = staff.name;
                selectEl.appendChild(option);
            });
            
            if (manualOverrides[dateString]) {
                if (manualOverrides[dateString].staffName === '休み') {
                    selectEl.value = '休み';
                } else {
                    selectEl.value = manualOverrides[dateString].staffId;
                }
            } else {
                selectEl.value = 'auto';
            }
            
            document.getElementById('edit-modal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('flex');
            editingDate = null;
        }

        async function saveEdit() {
            if (!editingDate) return;

            const selectedValue = document.getElementById('staff-select').value;
            const overrideRef = doc(db, `artifacts/${appId}/public/data/manualOverrides`, editingDate);

            if (selectedValue === 'auto') {
                await deleteOverride();
                return;
            }
            
            let data;
            if (selectedValue === '休み') {
                data = { staffId: null, staffName: '休み' };
            } else {
                const selectedStaff = staffList.find(s => s.id === selectedValue);
                data = { staffId: selectedStaff.id, staffName: selectedStaff.name };
            }

            try {
                await setDoc(overrideRef, data);
                showToast('担当者を変更しました', 'success');
                closeEditModal();
            } catch (error) {
                console.error("Error saving override:", error);
                showToast('変更の保存に失敗しました', 'error');
            }
        }
        
        async function deleteOverride() {
             if (!editingDate) return;
             const overrideRef = doc(db, `artifacts/${appId}/public/data/manualOverrides`, editingDate);
             try {
                await deleteDoc(overrideRef);
                showToast('自動割り当てに戻しました', 'success');
                closeEditModal();
             } catch(error) {
                console.error("Error deleting override:", error);
                showToast('リセットに失敗しました', 'error');
             }
        }

        function toYYYYMMDD(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function isLoggedIn() {
            return !loginModal.classList.contains('flex');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        let confirmCallback = null;
        const confirmModal = document.getElementById('confirm-modal');
        function showConfirmModal(text, onConfirm) {
            confirmModal.querySelector('#confirm-modal-text').textContent = text;
            confirmCallback = onConfirm;
            confirmModal.classList.add('flex');
        }

        // --- イベントリスナー ---
        loginButton.addEventListener('click', () => {
            if (passwordInput.value === settings.password) {
                loginModal.classList.remove('flex');
                appContainer.classList.remove('opacity-0');
                renderCalendar();
            } else {
                loginError.textContent = 'パスワードが違います。';
                setTimeout(() => loginError.textContent = '', 3000);
            }
        });
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginButton.click();
        });

        document.getElementById('prev-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        document.getElementById('today-button').addEventListener('click', () => {
            currentDate = new Date();
            renderCalendar();
        });
        
        const settingsModal = document.getElementById('settings-modal');
        document.getElementById('settings-button').addEventListener('click', () => {
             renderSettings(); // モーダルを開くたびに再描画
             settingsModal.classList.add('flex');
        });
        document.getElementById('close-settings-modal').addEventListener('click', () => settingsModal.classList.remove('flex'));
        
        document.getElementById('add-staff-button').addEventListener('click', async () => {
            const name = document.getElementById('new-staff-name').value;
            if (name.trim()) {
                try {
                    const maxOrder = staffList.reduce((max, staff) => Math.max(max, (staff.order !== undefined ? staff.order : -1)), -1);
                    await addDoc(collection(db, `artifacts/${appId}/public/data/staff`), {
                        name: name.trim(),
                        availableDays: [1, 2, 3, 4, 5],
                        order: maxOrder + 1
                    });
                    document.getElementById('new-staff-name').value = '';
                    showToast('担当者を追加しました', 'success');
                } catch (error) {
                    console.error("Error adding staff:", error);
                    showToast('担当者の追加に失敗しました', 'error');
                }
            }
        });
        document.getElementById('staff-list').addEventListener('click', async (e) => {
            const button = e.target.closest('.remove-staff-button');
            if (button) {
                const staffId = button.dataset.staffId;
                const staff = staffList.find(s => s.id === staffId);
                const staffName = staff ? staff.name : '';
                showConfirmModal(`「${staffName}」さんを削除しますか？`, async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/staff`, staffId));
                        showToast('担当者を削除しました', 'success');
                    } catch (error) {
                        console.error("Error removing staff:", error);
                        showToast('担当者の削除に失敗しました', 'error');
                    }
                });
            }
        });

        document.getElementById('add-holiday-button').addEventListener('click', () => {
            const newHoliday = document.getElementById('new-holiday').value;
            if (newHoliday && !(settings.holidays || []).includes(newHoliday)) {
                if (!settings.holidays) settings.holidays = [];
                settings.holidays.push(newHoliday);
                settings.holidays.sort();
                renderSettings();
            }
            document.getElementById('new-holiday').value = '';
        });
        document.getElementById('holiday-list').addEventListener('click', (e) => {
             const button = e.target.closest('.remove-holiday-button');
             if(button) {
                 const holidayToRemove = button.dataset.holiday;
                 settings.holidays = (settings.holidays || []).filter(h => h !== holidayToRemove);
                 renderSettings();
             }
        });
        
        document.getElementById('add-workday-override-button').addEventListener('click', () => {
            const newWorkday = document.getElementById('new-workday-override').value;
            if (newWorkday && !(settings.workdayOverrides || []).includes(newWorkday)) {
                if (!settings.workdayOverrides) settings.workdayOverrides = [];
                settings.workdayOverrides.push(newWorkday);
                settings.workdayOverrides.sort();
                renderSettings();
            }
            document.getElementById('new-workday-override').value = '';
        });
        document.getElementById('workday-override-list').addEventListener('click', (e) => {
             const button = e.target.closest('.remove-workday-override-button');
             if(button) {
                 const workdayToRemove = button.dataset.workday;
                 settings.workdayOverrides = (settings.workdayOverrides || []).filter(d => d !== workdayToRemove);
                 renderSettings();
             }
        });

        document.getElementById('reset-staff-button').addEventListener('click', () => {
            showConfirmModal('現在の担当者リストをすべて削除し、初期状態に戻します。この操作は元に戻せません。よろしいですか？', async () => {
                try {
                    const staffCollectionRef = collection(db, `artifacts/${appId}/public/data/staff`);
                    const querySnapshot = await getDocs(query(staffCollectionRef));
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    // 削除後に改めて初期リストを追加する
                    await addInitialStaff(staffCollectionRef); 
                    
                    showToast('担当者リストをリセットしました。', 'success');
                } catch(e) {
                    console.error("Failed to reset staff list:", e);
                    showToast('リセットに失敗しました。', 'error');
                }
            });
        });

        document.getElementById('save-settings-button').addEventListener('click', saveSettings);
        
        document.getElementById('close-edit-modal').addEventListener('click', closeEditModal);
        document.getElementById('save-edit-button').addEventListener('click', saveEdit);
        document.getElementById('reset-assignment-button').addEventListener('click', deleteOverride);

        document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
            confirmModal.classList.remove('flex');
            confirmCallback = null;
        });
        document.getElementById('confirm-modal-ok').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmModal.classList.remove('flex');
            confirmCallback = null;
        });


        // --- アプリケーション開始 ---
        initializeAppAndAuth();
    </script>
</body>
</html>

